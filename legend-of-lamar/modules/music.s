.data
# https://ciframelodica.com.br/musicas/zelda-saria-s-song-cancao-de-saria-931/
NOTES: .word 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 83, 214, 79, 214, 76, 1071, 74, 214, 76, 214, 79, 214, 76, 1285, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 88, 214, 83, 214, 79, 1071, 83, 214, 79, 214, 74, 214, 76, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 76, 214, 81, 428, 79, 214, 81, 214, 83, 428, 84, 214, 86, 214, 88, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 72, 214, 77, 214, 79, 214, 79, 214, 77, 214, 81, 214, 79, 214, 83, 214, 81, 214, 84, 214, 86, 214, 86, 214, 84, 214, 83, 107, 84, 107, 81, 107, 81, 107, 83, 1714, 95, 1285, 95, 214, 77, 214, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 83, 214, 79, 214, 76, 1071, 74, 214, 76, 214, 79, 214, 76, 1285, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 88, 214, 83, 214, 79, 1071, 83, 214, 79, 214, 74, 214, 76, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 76, 214, 77, 428, 83, 214, 81, 214, 83, 428, 84, 214, 86, 214, 88, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 72, 214, 77, 214, 76, 214, 83, 214, 77, 214, 81, 214, 79, 214, 83, 214, 81, 214, 84, 214, 83, 214, 89, 214, 84, 214, 83, 107, 84, 107, 81, 107, 81, 107, 83, 1714, 95, 1285, 95, 214, 77, 214, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 83, 214, 79, 214, 76, 1071, 74, 214, 76, 214, 79, 214, 76, 1285, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 88, 214, 83, 214, 79, 1071, 83, 214, 79, 214, 74, 214, 76, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 76, 214, 77, 428, 83, 214, 81, 214, 83, 428, 84, 214, 86, 214, 88, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 72, 214, 77, 214, 76, 214, 83, 214, 77, 214, 81, 214, 79, 214, 83, 214, 81, 214, 84, 214, 83, 214, 89, 214, 84, 214, 83, 107, 84, 107, 81, 107, 81, 107, 83, 1714, 95, 1285, 95, 214, 77, 214, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 83, 214, 79, 214, 76, 1071, 74, 214, 76, 214, 79, 214, 76, 1285, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 428, 77, 214, 81, 214, 83, 214, 88, 214, 86, 428, 83, 214, 84, 214, 88, 214, 83, 214, 79, 1071, 83, 214, 79, 214, 74, 214, 76, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 76, 214, 77, 428, 83, 214, 81, 214, 83, 428, 84, 214, 86, 214, 88, 1285, 62, 214, 64, 214, 65, 428, 67, 214, 69, 214, 71, 428, 72, 214, 71, 214, 64, 1285, 74, 214, 72, 214, 77, 214, 76, 214, 83, 214, 77, 214, 81, 214, 79, 214, 83, 214, 81, 214, 84, 214, 83, 214, 89, 214, 84, 214, 83, 107, 84, 107, 81, 107, 81, 107, 83, 1714, 83, 1285, 83, 214
			
NUM_OF_NOTES: .word 355 			# O numero de notas na verdade e esse valor dividido por 8, pra facilitar a logica
CURRENT_NOTE_INDEX: .word 0		# O indice sempre sera o numero que devemos adicionar no endereco original pra encontrar a nota atual
CURRENT_NOTE_DURATION: .word 214 # A duracao da nota atual para ser usada na main, inicialmente pode ser a primeira

.text

MUSIC_MANAGER:
	
	la t0, CURRENT_NOTE_DURATION		# So toca uma nota nova passados o tempo da ultima
	lw t0, 0(t0)						# Carrega o valor da duração da nota
	csrr t1, time 						# Carrega o tempo atual
	sub t1, t1, s9 						# Subtrai o tempo atual do tempo da ultima nota
	ble t1, t0, MUSIC_RET				# Não toca se n passou o tempo da nota
	b MUSIC_PLAY					# Toca a nota				


# Play
MUSIC_PLAY:
	la t0, NOTES		      	 	# Carrega o endereco inicial das notas
	la t1, CURRENT_NOTE_INDEX  		# Carrega o indice da nota atual
	la t3, CURRENT_NOTE_DURATION 	# Carrega o endereco da duracao da nota
	lw t2, 0(t1) 					# Carrega o valor do indice
	add t0, t0, t2 					# Adiciona o valor do indice no endereco das notas
	
	lw a0, 0(t0)  					# Carrega a nota atual
	lw a1, 4(t0)  					# Carrega a duracao
	li a2,0						# Define o intrumento MIDI
	li a3 110 						# Define o volume
	li a7 31 						# Define a chamada para o MIDI
	ecall							# toca a nota
	
	addi t2, t2, 8 					# Incrementar o valor do index
	sw t2, 0(t1) 					# Guardar proximo index no CURRENT_NOTE_INDEX
	sw a1, 0(t3)      				# Guarda a dura��o da nota no CURRENT_NOTE_DURATION
	
	# Se chegamos no indice final reseta a musica
	la t3, NUM_OF_NOTES 			# Carrega o endereco do NUM_OF_NOTES
	lw t3, 0(t3)		    		# Substitui o t3 pelo valor no endereco
	li t5, 8			    		# Carrega 8
	div t2, t2, t5					# Divide o valor do index por 8 para obter o numero da nota atual   	       
	ble  t2, t3, FIM_MUSIC		   	# Se o indice atual for maior do que o NUM_OF_NOTES agt zera o indice
	
	la t0, CURRENT_NOTE_INDEX 		# Carrega o endereco do index
	la t1, CURRENT_NOTE_DURATION 	# Carrega o endereco da nota atual
	la t2, NOTES 					# Carrega o endereço das 
	lw t3, 0(t2)					# Carrega a duração da primeira nota
	sw zero, 0(t0)			      	# Zera o valor
	sw t3, 4(t2)			      	# Carrega a duração da primeira nota
	
FIM_MUSIC:
	csrr s9, time	

MUSIC_RET:	
	ret
